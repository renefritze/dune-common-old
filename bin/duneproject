#!/bin/bash

#
# TODO:
#
# * anpasen, dass bei installiertem Dune das DUNEDIR nicht an
#   autogen.sh uebergeben weden muss.
#

set -e

echo Dune project/module generator
echo -----------------------------



################## READ OPTIONS ##################

while [ "$DATACORRECT" != "y" -a "$DATACORRECT" != "Y" ]; do
  PROJECT=""
  while [ -z $PROJECT ]; do
    read -p "New Project/Module name? " PROJECT
  done
  VERSION=""
  while [ -z $VERSION ]; do
    read -p "Project/Module version? " VERSION
  done
  MAINTAINER=""
  while [ -z $MAINTAINER ]; do
    read -p "Maintainers email address? " MAINTAINER
  done

  echo
  echo -n "creating Project \"$PROJECT\", version $VERSION "
  echo "with maintainer \"$MAINTAINER\""

  read -p "Are these informations correct? [y/N] " DATACORRECT
  echo
  echo "Look at README and dune.module files in the project"
  echo "Sometimes you may have to tweak the configure.ac a bit"
  echo "Now you can run dunecontrol script which would setup new module"
done


mkdir "$PROJECT"

################## dune.module ##################
cat > "$PROJECT/dune.module" <<C_DELIM

#dune module information file#
##############################

#Name of the module
Module:dune_$PROJECT
#depending on 
Depends:dune_common dune_grid dune_disc dune_istl
C_DELIM

################## CONFIGURE.AC ##################
cat > "$PROJECT/configure.ac" <<C_DELIM
#                                               -*- Autoconf -*-
# Process this file with autoconf to produce a configure script.
AC_PREREQ(2.50)
AC_INIT($PROJECT, $VERSION, $MAINTAINER)
AM_INIT_AUTOMAKE($PROJECT, $VERSION, $MAINTAINER)
AC_CONFIG_SRCDIR([$PROJECT.cc])
AM_CONFIG_HEADER([config.h])


# we need no more than the standard DUNE-stuff
DUNE_CHECK_ALL([dunecommon],[dunegrid],[duneistl],[dunedisc])
if test x\$HAVE_DUNECOMMON != x1 ; then
  AC_MSG_ERROR([Can't work without the dune-common module. Maybe you have to supply your dune-common directory as --with-dunecommon=dir])
fi

if test x\$HAVE_DUNEGRID != x1 ; then
  AC_MSG_ERROR([Can't work without the dune-grid module. Maybe you have to supply your dune-grid directory as --with-dunegrid=dir])
fi

if test x\$HAVE_DUNEDISC != x1 ; then
  AC_MSG_ERROR([Can't work without the dune-disc module. Maybe you have to supply your dune-disc directory as --with-dunedisc=dir])
fi

if test x\$HAVE_DUNEISTL != x1 ; then
  AC_MSG_ERROR([Can't work without the dune-istl module. Maybe you have to supply your dune-istl directory as --with-duneistl=dir])
fi


# implicitly set the Dune-flags everywhere
AC_SUBST(AM_CPPFLAGS, \$DUNE_CPPFLAGS)
AC_SUBST(AM_LDFLAGS, \$DUNE_LDFLAGS)
LIBS="\$DUNE_LIBS"

AC_CONFIG_FILES([Makefile])
AC_OUTPUT
# finally print the summary information
DUNE_SUMMARY_ALL
C_DELIM

################## AUTOGEN.SH ##################
cat > "$PROJECT/autogen.sh" <<A_DELIM
#!/bin/sh
# $Id$

# barf on errors
set -e

usage () {
    echo "Usage: ./autogen.sh [options]"
    echo "  --ac=, --acversion=VERSION   use a specific VERSION of autoconf"
    echo "  --am=, --amversion=VERSION   use a specific VERSION of automake"
    echo "  -h,    --help                you already found this :-)"
}

for OPT in "\$@"; do
    set +e
    # stolen from configure...
    # when no option is set, this returns an error code
    arg=\`expr "x\$OPT" : 'x[^=]*=\(.*\)'\`
    set -e

    case "\$OPT" in
	--ac=*|--acversion=*)
			if test "x\$arg" == "x"; then
				usage; 
				exit 1;
			fi
			ACVERSION=\$arg
			;;
	--am=*|--amversion=*)
			if test "x\$arg" == "x"; then
				usage; 
				exit 1;
			fi
			AMVERSION=\$arg
			;;
	-h|--help) usage ; exit 0 ;;
	*)
            if test -d "\$OPT/m4"; then
              ACLOCAL_FLAGS="\$ACLOCAL_FLAGS -I \$OPT/m4"
            fi
            if test -d "\$OPT/am"; then
              am_dir="\$OPT/am"
            fi
            ;;
    esac
done

## report parameters
if test "x\$ACVERSION" != "x"; then
	echo "Forcing autoconf version «\$ACVERSION»"
	if ! which autoconf\$ACVERSION > /dev/null; then
		echo
		echo "Error: Could not find autoconf\$ACVERSION"
		echo "       Did you specify a wrong version?"
		exit 1
	fi
fi
if test "x\$AMVERSION" != "x"; then
	echo "Forcing automake version «\$AMVERSION»"
	if ! which automake\$AMVERSION > /dev/null; then
		echo
		echo "Error: Could not find automake\$AMVERSION"
		echo "       Did you specify a wrong version?"
		exit 1
	fi
fi


## run autotools

echo "--> libtoolize..."
# this script won't rewrite the files if they already exist. This is a
# PITA when you want to upgrade libtool, thus I'm setting --force
libtoolize --force

# prepare everything
echo "--> aclocal..."
aclocal\$AMVERSION \$ACLOCAL_FLAGS

# applications should provide a config.h for now
echo "--> autoheader..."
autoheader\$ACVERSION

# create a link to the dune-common am directory
echo "--> linking dune-common/am..."
rm -f am
ln -s \$am_dir am

# call automake/conf
echo "--> automake..."
automake\$AMVERSION --add-missing

echo "--> autoconf..."
autoconf\$ACVERSION

## tell the user what to do next
echo "Now run ./configure "

A_DELIM

chmod +x "$PROJECT/autogen.sh"

################## README ##################
cat > "$PROJECT/README" <<R_DELIM
Preparing the Sources
=========================

Additional to the software mentioned in README you'll need the
following programs installed on your system:

  automake >= 1.5

  autoconf >= 2.50

  libtool

Getting started
---------------

If these preliminaries are met, you should run the script

  ./autogen.sh

which calls the GNU autoconf/automake to create a ./configure-script
and the Makefiles. Most probably you'll have to provide where to find
the DUNE-files by

   ./autogen.sh --with-dune=PATH

where PATH is a directory with a dune/-subdirectory inside (this
convention is needed to keep the #include-syntax consistent even when
the headers are installed into /usr/include/dune later).


Passing options to ./configure
------------------------------

autogen.sh also calls the newly created configure-script to
conveniently pass on options about the used compiler. Thus you'll have
to provide autogen.sh any options you want configure to get, e.g.

  ./autogen.sh --with-dune=... --with-albert=... --without-x


Choosing the compiler and the options
-------------------------------------

The selection of the compiler works as follows: if --gnu or --intel is
passed to autogen it reads the content of gcc.opts or icc.opts to get
the default compiler flags. With the option --optim you can switch the
compiler-specific optimization parameters on.

If you want to change the compiler options to your favourites you can
either

 - adapt the appropriate .opts-file and rerun autogen.sh. Please don't
   commit this changed file to CVS if you're not sure if the options
   work for everybody.

 - copy an existing .opts-file to a new name, change the options and
   use

      ./autogen.sh --opts=my.opts


More info
---------

See

     ./autogen.sh --help
   
and (if it exists)
 
     ./configure --help

for further options.


The full build-system is described in the dune/doc/Buildsystem (not in
duneapps/doc!)

\$Id$

R_DELIM

################## MAKEFILE.AM ##################
cat> "$PROJECT/Makefile.am" << M_DELIM
# \$Id$

# possible options
#LDADD = \$(UG_LDFLAGS) \$(AMIRAMESH_LDFLAGS) \$(UG_LIBS) \$(AMIRAMESH_LIBS)
#AM_CPPFLAGS = \$(UG_CPPFLAGS) \$(AMIRAMESH_CPPFLAGS)

noinst_PROGRAMS = ${PROJECT}

${PROJECT}_SOURCES = ${PROJECT}.cc

${PROJECT}_CXXFLAGS = \$(MPI_CPPFLAGS) \$(UG_CPPFLAGS) \$(AMIRAMESH_CPPFLAGS) \$(ALBERTA_CPPFLAGS) -DWITH_INDEX_SETS
${PROJECT}_LDADD = \$(MPI_LDFLAGS) \$(ALBERTA_LDFLAGS) \$(ALBERTA_LIBS) \$(AMIRAMESH_LDFLAGS) \$(AMIRAMESH_LIBS) \$(UG_LDFLAGS) \$(UG_LIBS) \$(MPI_LDFLAGS) \$(DUNE_LDFLAGS) \$(DUNE_LIBS)

# don't follow the full GNU-standard
# we need automake 1.5
AUTOMAKE_OPTIONS = foreign 1.5
# pass most important options when "make distcheck" is used
DISTCHECK_CONFIGURE_FLAGS = --with-dune=\$(DUNEROOT) CXX="\$(CXX)" CC="\$(CC)"
M_DELIM

################## PROJECT.CC ##################
cat> "$PROJECT/$PROJECT.cc" << CC_DELIM
#ifdef HAVE_CONFIG_H
# include "config.h"     
#endif
#include <iostream>
#include"dune/grid/sgrid.hh" // load sgrid definition 
#include"dune/grid/common/gridinfo.hh" // definition of gridinfo 
int main()
{
 try
	 {
  std::cout << "Hello World! This is ${PROJECT}." << std::endl;
// make a grid 
const int dim=3; 
typedef Dune::SGrid<dim,dim> GridType; 
Dune::FieldVector<int,dim> N(3); 
Dune::FieldVector<GridType::ctype,dim> L(-1.0); 
Dune::FieldVector<GridType::ctype,dim> H(1.0); 
GridType grid(N,L,H); 
// print some information about the grid 
  Dune::gridinfo(grid); 
  return 0;
     }
 catch (Dune::Exception &e)
	{
		std::cerr << "Dune reported error: " << e << std::endl;
	}
  catch (...)
	{
	  std::cerr << "Unknown exception thrown!" << std::endl;
	};
}
CC_DELIM

################## GCC.OPTS ##################
cat> "$PROJECT/gcc.opts" << GCC_DELIM
# \$Id$

# options for gcc/g++
# remember to run ./autogen.sh after changing these values!

# name of compiler binaries
COMP="gcc"
CXXCOMP="g++"

# flags set in any case
FLAGS="-Wall"

# additional flags for debugging
DEBUGFLAGS="-g"

# additional flags for optimization
OPTIMFLAGS="-O3"

GCC_DELIM

################## GCC.OPTS ##################
cat> "$PROJECT/icc.opts" << ICC_DELIM
# \$Id$

# options for icc
# remember to run ./autogen.sh after changing these values!

# name of compiler binaries
COMP="icc"
CXXCOMP="icc"

# flags set in any case
FLAGS="-Wall"

# additional flags for debugging
DEBUGFLAGS="-O0 -g"

# additional flags for optimization
OPTIMFLAGS="-O3 -Ob2 -unroll"

ICC_DELIM
